<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<mapper namespace="approvalMapper">

	<resultMap type="kh.study.intranet.approval.vo.ApprovalVO" id="approval">
		<id column="APP_SEQ" 					property="appSeq"/>
		<result column="APP_WRITE_DATE" 		property="appWriteDate"/>
		<result column="TITLE" 					property="title"/>
		<result column="APP_CATE_CODE" 			property="appCateCode"/>
		<result column="FIRST_TIME_APPROVER" 	property="firstTimeApprover"/>
		<result column="INTERMIDIATE_APPROVER" 	property="intermidiateApprover"/>
		<result column="FINAL_APPROVER" 		property="finalApprover"/>
		<result column="APP_CHECK_STATUS" 		property="appCheckStatus"/>
		<association property="empVO" resultMap="empMapper.emp"/>
		<association property="appCategoryVO" resultMap="appCategory"/>
		<association property="vacationVO" resultMap="vacation"/>
		<association property="nomalVO" resultMap="nomal"/>
		<association property="accountingVO" resultMap="accounting"/>
	</resultMap>
	
	
	
	<resultMap type="kh.study.intranet.approval.vo.AppCategoryVO" id="appCategory">
		<id column="APP_CATE_CODE" 		property="appCateCode"/>
		<result column="APP_CATE_NAME" 		property="appCateName"/>
	</resultMap>
	
	<resultMap type="kh.study.intranet.approval.vo.VacationVO" id="vacation">
		<id column="VACATION_SEQ" 		property="vacationSeq"/>
		<result column="VACATION_CONTENT" 		property="vacationContent"/>
		<result column="VACATION_STRAT_DATE" 		property="vacationStartDate"/>
		<result column="VACATION_END_DATE" 		property="vacationEndDate"/>
		<result column="VACATION_PERIOD_DATE" 		property="vacationPeriodDate"/>
		<result column="USER_ID" 		property="userId"/>
		<result column="APP_SEQ" 		property="appSeq"/>
		
	</resultMap>
	
	<resultMap type="kh.study.intranet.approval.vo.NomalVO" id="nomal">
		<id column="NOMAL_SEQ" 		property="nomalSeq"/>
		<result column="NOMAL_CONTENT" 		property="nomalContent"/>
		<result column="APP_SEQ" 		property="appSeq"/>
		<result column="USER_ID" 		property="userId"/>
	</resultMap>
	
	<resultMap type="kh.study.intranet.approval.vo.AccountingVO" id="accounting">
		<id column="ACCOUNTING_SEQ" 		property="accountingSeq"/>
		<result column="PAYMENT_REQUEST_DATE" 		property="paymentRequestDate"/>
		<result column="ACCOUNTING_CLIENT" 		property="accountingClient"/>
		<result column="ACCOUNT_NUMBER" 		property="accountNumber"/>
		<result column="ACCOUNT" 		property="account"/>
		<result column="BUSINESS_REGISTRATION_NUMBER" 		property="businessRegistrationNumber"/>
		<result column="AMOUNT" 		property="amount"/>
		<result column="ACCOUNTING_CONTENT" 		property="accountingContent"/>
		<result column="ACCOUNTING_CATEGORY" 		property="accountingCategory"/>
		<result column="USER_ID" 		property="userId"/>
		<result column="APP_SEQ" 		property="appSeq"/>
	</resultMap>
	
	<select id="getAppSeq" resultMap="approval">
		SELECT (SELECT 'APP_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(APP_SEQ, 5))), 0) + 1, 3, 0) FROM APPROVAL) APP_SEQ
        ,TO_CHAR(SYSDATE,'YYYY-MM-DD') AS APP_WRITE_DATE
		FROM DUAL
	</select>
	
	
	<select id="selectAppEmp" resultMap="empMapper.emp">
		SELECT EMP_NAME
			, EMP.DEPT_NAME
		FROM EMP, DEPT
		WHERE EMP.DEPT_CODE = DEPT.DEPT_CODE
		AND USER_ID = #{userId}
	</select>
	
	
	<insert id="insertApproval">
		INSERT INTO APPROVAL(
			APP_SEQ
            ,USER_ID
            ,TITLE
            ,APP_CATE_CODE
		) VALUES(
			(SELECT 'APP_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(APP_SEQ, 5))), 0) + 1, 3, 0) FROM APPROVAL)
            ,#{userId}
            ,#{title}
            ,#{appCateCode}
		)
	</insert>
	
	<insert id="insertVacation">
		<selectKey resultType="String" keyProperty="vacationSeq" order="BEFORE">
			SELECT 'VACATION_APP_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(VACATION_SEQ, 14))), 0) + 1, 3, 0) 
			FROM APP_FORM_VACATION  
		</selectKey>
		INSERT INTO APP_FORM_VACATION (
			APP_SEQ
			, VACATION_SEQ
			, VACATION_START_DATE
			, VACATION_END_DATE
			, VACATION_PERIOD_DATE
			, VACATION_CONTENT
			, USER_ID
		)VALUES (
			#{appSeq}
			, #{vacationSeq}
			, #{vacationStartDate}
			, #{vacationEndDate}
			, #{vacationPeriodDate}
			, #{vacationContent}
			, #{userId}
		)
	</insert>
	
	<insert id="insertNomal">
		<selectKey resultType="String" keyProperty="nomalSeq" order="BEFORE">
			SELECT 'NOMAL_APP_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(NOMAL_SEQ, 11))), 0) + 1, 3, 0) 
			FROM APP_FORM_NOMAL  
		</selectKey>
		INSERT INTO APP_FORM_NOMAL (
			APP_SEQ
			, NOMAL_SEQ
			, NOMAL_CONTENT
			, USER_ID
		)VALUES (
			#{appSeq}
			, #{nomalSeq}
			, #{nomalContent}
			, #{userId}
		)
	</insert>
	
	<insert id="insertAccounting">
		<selectKey resultType="String" keyProperty="accountingSeq" order="BEFORE">
			SELECT 'ACCOUNTING_APP_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(ACCOUNTING_SEQ, 16))), 0) + 1, 3, 0) 
			FROM APP_FORM_ACCOUNTING  
		</selectKey>
		INSERT INTO APP_FORM_ACCOUNTING (
			ACCOUNTING_SEQ
			, PAYMENT_REQUEST_DATE
			, ACCOUNTING_CLIENT
			, ACCOUNT_NUMBER
			, ACCOUNT
			, BUSINESS_REGISTRATION_NUMBER
			, AMOUNT
			, ACCOUNTING_CONTENT
			, ACCOUNTING_CATEGORY
			, APP_SEQ
			, USER_ID
		)VALUES (
			#{accountingSeq}
			, #{paymentRequestDate}
			, #{accountingClient}
			, #{accountNumber}
			, #{account}
			, #{businessRegistrationNumber}
			, #{amount}
			, #{accountingContent}
			, #{accountingCategory}
			, #{appSeq}
			, #{userId}
		)
	</insert>
	
	
	
	
	
	
	<select id="selectApp" resultMap="approval">
		SELECT APPROVAL.APP_SEQ
			, APP_WRITE_DATE
			, APPROVAL.APP_CATE_CODE
	        , TITLE
            , APPROVAL.USER_ID
            , APP_CHECK_STATUS
            ,(SELECT EMP_NAME FROM EMP WHERE EMP.USER_ID = APPROVAL.USER_ID) AS EMP_NAME 
            ,(SELECT DEPT_NAME FROM EMP WHERE EMP.USER_ID = APPROVAL.USER_ID) AS DEPT_NAME 
		FROM APPROVAL , APP_CATEGORY CATEGORY
		WHERE APPROVAL.APP_CATE_CODE = CATEGORY.APP_CATE_CODE
		<if test="appSeq != null and !appSeq.equals('')">
		AND APPROVAL.APP_SEQ = #{app_seq}
		</if>
		<if test="title != null and !title.equals('')">
		AND UPPER(TITLE) LIKE UPPER('%'||#{title}||'%')
		</if>		
		<if test="userId != null and !userId.equals('')">
		AND APPROVAL.USER_ID = #{userId}
		</if>
		<if test="appCateCode != null and !appCateCode.equals('')">
		AND APPROVAL.APP_CATE_CODE = #{appCateCode}
		</if>
		<if test="fromDate != null and !fromDate.equals('')">
		AND TO_CHAR(APP_WRITE_DATE, 'YYYY-MM-DD') &gt;= #{fromDate}  
		</if>		
		<if test="toDate != null and !toDate.equals('')">
		AND TO_CHAR(APP_WRITE_DATE, 'YYYY-MM-DD') &lt;= #{toDate}
		</if>		
		<!-- <if test="appCheckStatus != null and !appCheckStatus.equals('')">
		AND APP_CHECK_STATUS = #{appCheckStatus}
		</if> -->
		ORDER BY APPROVAL.APP_SEQ DESC
		
		
	</select>
	
	<select id="selectBoxList" resultMap="approval"> 
		SELECT DISTINCT APP_CATE_NAME
		FROM APPROVAL,APP_CATEGORY
		WHERE APPROVAL.APP_CATE_CODE = APP_CATEGORY.APP_CATE_CODE 
		<!-- DISTINCT -->
	</select> 
	
	
	
</mapper>



